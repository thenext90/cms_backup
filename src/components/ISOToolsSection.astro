---
import { Clock, TrendingUp, Sparkles, Users, AlertCircle } from 'lucide-astro';

// Función para obtener datos de ISOTools usando archivo RAW
async function getISOToolsData() {
  try {
    const timestamp = Date.now();
    // Usar archivo RAW de GitHub con cache-busting
    const response = await fetch(`https://raw.githubusercontent.com/thenext90/noticias_isotools_cms/main/isotools-daily-news.json?t=${timestamp}`, {
      cache: 'no-cache',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    
    if (!response.ok) {
      console.warn('No se pudieron cargar los datos de ISOTools');
      return null;
    }
    
    return await response.json();
  } catch (error) {
    console.error('Error al cargar datos de ISOTools:', error);
    return null;
  }
}

let isoData = null;
try {
  isoData = await getISOToolsData();
  console.log('Datos de ISOTools cargados:', isoData ? 'Éxito' : 'Falló');
  if (isoData) {
    console.log('Artículos encontrados:', isoData.daily_news ? isoData.daily_news.length : 'No hay daily_news');
  }
} catch (error) {
  console.error('Error fetching ISOTools data:', error);
}

// Datos de fallback si no se pueden cargar los datos reales
const fallbackData = {
  metadata: {
    total_articles: 5,
    ai_model: "OpenAI GPT-3.5-turbo"
  },
  data: [
    {
      id: 1,
      title: "Riesgos psicosociales avanzados: la nueva frontera de la seguridad laboral en ISO 45001",
      url: "https://www.cmsconsultores.cl/riesgos-psicosociales",
      ai_summary: "La evaluación avanzada de riesgos psicosociales se posiciona como elemento crítico en los sistemas de gestión de seguridad laboral. Las organizaciones deben implementar metodologías de detección temprana de burnout, análisis de clima organizacional, gestión del estrés laboral y protocolos de bienestar mental. Esta evolución incluye herramientas de monitoreo continuo y programas preventivos que protegen la salud mental como componente esencial de la seguridad ocupacional.",
      category: "ISO_45001_Riesgos_Psicosociales",
      extracted_at: "2025-10-03T01:48:36.651Z"
    },

    {
      id: 3,
      title: "Cumplimiento ISO 27001: los 9 pasos esenciales para preparar tu certificación",
      url: "https://www.isotools.us/",
      ai_summary: "El cumplimiento de la norma ISO 27001 es crucial para garantizar la seguridad de la información en las organizaciones.",
      category: "ISO_27001_Seguridad_Informacion",
      extracted_at: "2025-10-03T01:48:36.651Z"
    }
  ],
  statistics: {
    ai_success_rate: "100%"
  }
};

// Usar datos reales o fallback y filtrar la noticia específica
let displayData = isoData || fallbackData;

// Adaptar estructura del nuevo JSON (daily_news vs data)
if (displayData && displayData.daily_news) {
  // Nuevo formato: usar daily_news
  displayData.data = displayData.daily_news;
} else if (displayData && !displayData.data) {
  // Si no hay datos, usar fallback
  displayData = fallbackData;
}

// Función para formatear la fecha
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Función para mostrar texto completo (sin truncar)
function truncateText(text, maxLength = 999999) {
  // Mostrar texto completo sin límite
  return text;
}
---

<section class="pb-6 pt-12 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Titular con el mismo estilo que los años en NewsSection -->
    <div class="text-center mb-12">
      <h2 class="text-xl font-bold text-accent-800 bg-accent-50 inline-block px-6 py-3 rounded-full border-2 border-accent-200">
        Consejos y tendencias para ayudarte a mejorar tus sistemas de gestión
      </h2>
    </div>
    
    {displayData && displayData.data ? (
      <!-- Grid de artículos -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
        {displayData.data.map((article) => (
          <article class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group focus:outline-none focus:ring-2 focus:ring-gold transform hover:scale-105 transition-transform duration-200" tabindex="0" role="article" aria-label={article.title}>
            <!-- Header del artículo -->
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-start justify-between mb-3">
                <div></div>
                <div class="flex items-center text-gray-500">
                  <Clock size="14" class="mr-1" />
                  <span class="text-xs">{formatDate(article.extracted_at)}</span>
                </div>
              </div>
              
              <h3 class="text-lg font-bold text-gray-800 leading-tight mb-3 group-hover:text-accent-800 transition-colors">
                {article.title}
              </h3>
            </div>

            <!-- Contenido del artículo -->
            <div class="p-6">
              <p class="text-gray-600 text-sm leading-relaxed mb-4">
                {truncateText(article.ai_summary)}
              </p>
              
              <div class="flex items-center justify-between">
                <div class="flex items-center text-xs text-gray-500">
                  <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">
                    ✨ Resumen IA
                  </span>
                </div>
                <div class="flex items-center text-xs text-gray-400">
                  <span>Fuente: isotools.us</span>
                </div>
              </div>
            </div>
          </article>
        ))}
      </div>
    ) : (
      <!-- Estado de carga/error -->
      <div class="text-center py-12">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md mx-auto">
          <AlertCircle size="48" class="text-yellow-500 mx-auto mb-4" />
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Contenido no disponible</h3>
          <p class="text-gray-600">No se pudieron cargar los artículos en este momento.</p>
        </div>
      </div>
    )}
  </div>
</section>